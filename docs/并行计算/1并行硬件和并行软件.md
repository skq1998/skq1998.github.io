---
category: 并行计算
share: true
---

> [!info] 
>为了编写高效的并行程序，我们需要对底层的硬件和系统软件有所了解。理解不同类型并行软件的相关知识是有用的。

本章主要内容

- 介绍硬件和软件方面的一些知识
- 简略介绍如何评价程序性能以及开发并行程序的方法
- 介绍在本书中其余部分设计的开发环境、规则以及一些假设

在阅读后面的章节时，如果对某个概念和名词不清楚，你需要回到本章节查询。

## 1 背景知识

并行硬件和并行软件是从传统的一次只执行单个任务的串行硬件和串行软件中发展出来的。为了更好地理解并行系统地状况，我们需要先了解串行系统的特点。

### 1.1 冯 · 诺伊曼结构

“经典” 的冯 · 诺伊曼结构包括

- 主存
- 中央处理单元（Central Processing Unit，即 CPU）处理器或核
- 主存和 CPU 之间的互连结构

**主存**中有许多区域，每个区域都可以存储指令和数据。每个区域都有一个地址，可以通过这个地址来访问相对应区域及区域中存储的数据和指令。

**中央处理器单元**分为**控制单元**和**算数逻辑单元 (Arithmetic Logic Unit, ALU)**。控制单元负责决定应该执行程序中的哪些指令，而 ALU 负责执行指令。CPU 中的数据和程序执行时的状态信息存储在特殊的快速存储介质中，即**寄存器**。在 ALU 和控制单元中都有寄存器，其中控制单元中有一个特殊的寄存器，叫程序计算器，用来存放下一条指令的地址。

**指令和数据**通过 CPU 和主存之间的**互连结构**进行传输。这种互连结构通常是**总线**，总线中包括一组并行的线以及控制这些先的硬件。冯 · 诺依曼机器一次执行一条指令，每条指令对一个数据进行操作。

![300](../assets/img/1%E5%B9%B6%E8%A1%8C%E7%A1%AC%E4%BB%B6%E5%92%8C%E5%B9%B6%E8%A1%8C%E8%BD%AF%E4%BB%B6_image_1.png)

主存和 CPU 之间的分离称为冯 · 诺伊曼结构瓶颈。这是因为互联结构限制了指令和数据访问的速率。程序运行所需要的大部分数据和指令被有效地与 CPU 隔离开。

### 1.2 进程、多任务和线程

>操作系统（Operating System , OS）：用来管理计算机的软件和硬件资源的主要软件。它决定什么程序能运行以及什么时候运行。它控制运行中程序的**内存分配**以及对诸如硬盘、网卡等外设的访问。

当用户运行一个程序时，操作系统创建一个进程。进程是运行着的程序的一个实例。一个进程包括如下实体：

- 可执行的机器语言程序
- 一块内存空间，包括可执行代码，一个用来跟踪执行函数的**调用栈**、一个**堆**，以及一些其他内存区域。
- 操作系统分配给进程的资源描述符，如文件描述符。
- 安全信息，例如阐述进程能够访问哪些硬件和软件的信息。
- 进程状态信息，例如进程是否就绪还是等到某些资源、寄存器内容，以及关于进程存储空间的信息。

大多数现代操作系统是多任务的。这意味着操作系统提供对同时运行多个程序的支持。**这对于单核系统也是可行的**，因为每个进程只运行一小段时间（几毫秒），亦即一个**时间片**。在一个程序执行了一个时间片的时间后，操作系统就切换执行其他程序。

在一个多任务操作系统中，如果一个进程需要等待某个资源，例如需要从外部的存储读取数据，它会**阻塞**。这意味着，该进程会停止运行，同时操作系统仍然可以运行其他进程。但是，从我们的需求的角度，许多程序需要能够继续运行即使当前运行的部分必须等待某些资源。例如，航班预订系统在一个用户因为等待座位图而阻塞时，我们需要确保另一个用户能够查询业务。线程为程序猿提供了一种机制，将程序划分为多个大致独立的任务，当某个任务阻塞时能执行其他任务。此外，在大多数系统中，线程的切换比进程快。因为线程相对于进程而言是“轻量级” 的。线程包含在进程中，所以线程可以使用相同的可执行代码，共享相同的内存和相同的 I/O 设备。实际上，当两个线程共属于同一个进程时，它们共享进程的大多数资源。它们之间最大的差别是各自需要一个私有程序计数器和函数调用栈，使它们能够独立运行。

如果进程是执行的“主线程”，其他线程由主线程启动和停止，那么我们可以设想进程和它的子线程如下进行，当一个线程开始时，它从进程中派生（fork）出来；当一个线程结束时，它合并（join）到进程中，如下图。

![400](../assets/img/1%E5%B9%B6%E8%A1%8C%E7%A1%AC%E4%BB%B6%E5%92%8C%E5%B9%B6%E8%A1%8C%E8%BD%AF%E4%BB%B6_image_2.png)

这里只是对线程和进程的一个简单介绍，如果需要更详细的解释，需要参考“操作系统”。这里从整本书的角度来看，线程各个同时运行的程序能共享内存，进程就是各个程序完全独立，不能共享内存。

关于 CPU 超线程技术可以参考 [CPU工作方式、多核心、超线程技术详解](https://zhuanlan.zhihu.com/p/52112475)

关于并发，参考下图

![400](../assets/img/1%E5%B9%B6%E8%A1%8C%E7%A1%AC%E4%BB%B6%E5%92%8C%E5%B9%B6%E8%A1%8C%E8%BD%AF%E4%BB%B6_image_3.png)

### 1.3 对冯 · 诺伊曼模型的改进

在本节中，我们有三种改进措施：

- **缓存（caching）**
- **虚拟存储器（或虚拟内存）**
- **低层次并行**

#### 1.3.1 Cache 基础知识

>缓存是解决冯 · 诺伊曼瓶颈最广泛使用的方法之一。

缓存从两个方面着手解决瓶颈：

1. 将互连通路加宽，使得一次内存访问能够传送更多的数据和更多的指令；
2. 将部分数据或者代码块存储在一个靠近 CPU 寄存器的特殊存储器里。

一般来说，对于高速缓冲储存器（cache，简称缓存）的访问时间比其他存储区域的访问时间短。在本书中，当谈到缓存时，一般指的是 **CPU 缓存**（CPU Cache）。CPU Cache 位于与 CPU 同一块的芯片或者位于其他芯片上，但比普通的内存芯片能更快地访问。

有了 Cache 后，一个明显的问题是什么样的数据和指令能够存储在 Cache 中。通用的准则基于下面的原理：程序接下来可能会用到的指令和数据与最近访问过的指令和数据在物理上是邻近存放的。
